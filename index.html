<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Clientes</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5oZ2e/g6J6i+k7s/3qT9x8jS2y4y5J7Wp7Gf5+1jR6A+2z1aW6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for better aesthetics if needed */
        .rounded-xl {
            border-radius: 0.75rem;
        }
        .shadow-2xl {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 flex items-center justify-center p-4">

    <div id="app" class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-8">
            Gestión de Clientes
        </h1>

        <div id="message-container" class="mb-4 p-3 text-sm text-center text-white bg-blue-500 rounded-md hidden"></div>
        
        <!-- User Login Form -->
        <div id="auth-view">
            <div class="mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4 text-center">Validar Usuario y Suscripción</h2>
                <form id="user-login-form" class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico</label>
                        <input type="email" id="login-email" placeholder="Ej. xyz@example.com" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" required>
                    </div>
                    <div>
                        <label for="login-client-idx" class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                        <input type="text" id="login-client-idx" placeholder="Ej. 04241234567" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" required>
                    </div>
                    <button type="submit" id="user-login-btn" class="w-full py-3 px-6 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75">
                        Verificar
                    </button>
                </form>
            </div>
        </div>

        <!-- User View -->
        <div id="user-view" class="hidden flex-col items-center">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Datos del Usuario</h2>
            <div id="logged-in-user-data" class="bg-white p-8 rounded-xl shadow-lg border border-gray-200 w-full text-left mb-6 bg-gradient-to-br from-gray-100 to-gray-50">
                <table class="w-full table-auto">
                    <tbody>
                        <tr>
                            <td class="w-1/2 flex items-center space-x-2 text-gray-700 text-lg py-2">
                                <i class="fa-solid fa-user fa-xl text-gray-500"></i>
                                <span class="font-bold">Nombre:</span>
                            </td>
                            <td class="text-gray-700 text-lg py-2"><span id="user-display-name"></span></td>
                        </tr>
                        <tr>
                            <td class="w-1/2 flex items-center space-x-2 text-gray-700 text-lg py-2">
                                <i class="fa-solid fa-envelope fa-xl text-gray-500"></i>
                                <span class="font-bold">Correo:</span>
                            </td>
                            <td class="text-gray-700 text-lg py-2"><span id="user-display-email"></span></td>
                        </tr>
                        <tr>
                            <td class="w-1/2 flex items-center space-x-2 text-gray-700 text-lg py-2">
                                <i class="fa-solid fa-phone fa-xl text-gray-500"></i>
                                <span class="font-bold">Teléfono:</span>
                            </td>
                            <td class="text-gray-700 text-lg py-2"><span id="user-display-phone"></span></td>
                        </tr>
                        <tr>
                            <td class="w-1/2 flex items-center space-x-2 text-gray-700 text-lg py-2">
                                <i class="fa-solid fa-calendar-days fa-xl text-gray-500"></i>
                                <span class="font-bold">Validez:</span>
                            </td>
                            <td class="text-gray-700 text-lg py-2"><span id="user-display-fin"></span></td>
                        </tr>
                        <tr>
                            <td class="w-1/2 flex items-center space-x-2 text-gray-700 text-lg py-2">
                                <i class="fa-solid fa-file-invoice fa-xl text-gray-500"></i>
                                <span class="font-bold">Suscripción: </span> 
                            </td>
                            <td class="text-gray-700 text-lg py-2"><span id="user-display-status"></span></td>
                        </tr>
                        <tr>
                            <td class="w-1/2 flex items-center space-x-2 text-gray-700 text-lg py-2">
                                <i class="fa-solid fa-sticky-note fa-xl text-gray-500"></i>
                                <span class="font-bold">Nota:</span>
                            </td>
                            <td class="text-gray-700 text-lg py-2"><span id="user-display-nota"></span></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <button id="user-logout-btn" class="mt-2 w-full py-3 px-6 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75">
                Cerrar Sesión
            </button>
        </div>
    </div>
    
    <script>
        // --- ADVERTENCIA: CREDENCIALES DE ADMINISTRADOR PARA DEMOSTRACIÓN ---
        const ADMIN_EMAIL = 'admin@vip.com';
        const ADMIN_PHONE = 'cela1969';

        // DOM Elements
        const messageContainer = document.getElementById('message-container');
        const authView = document.getElementById('auth-view');
        const userView = document.getElementById('user-view');

        // User login form elements
        const userLoginForm = document.getElementById('user-login-form');
        const loginEmailInput = document.getElementById('login-email');
        const loginClientIdxInput = document.getElementById('login-client-idx'); 
        const userLoginBtn = document.getElementById('user-login-btn'); 

        // User view display elements
        const userDisplayEmail = document.getElementById('user-display-email');
        const userDisplayName = document.getElementById('user-display-name');
        const userDisplayPhone = document.getElementById('user-display-phone'); 
        const userDisplayFin = document.getElementById('user-display-fin');
        const userDisplayStatus = document.getElementById('user-display-status');
        const userDisplayNota = document.getElementById('user-display-nota');
        
        const userLogoutBtn = document.getElementById('user-logout-btn');
        
        // !!! IMPORTANTE: REEMPLAZA ESTA URL CON LA URL DE DESPLIEGUE DE TU APPS SCRIPT !!!
        const appsScriptUrl = 'https://script.google.com/macros/s/AKfycbxyfhWoAzcN9Pf5VP3M39szabUhSvUJvJDEXKIliMSLQD-4QHsb9kFVerWcuAD77xjqJw/exec'; 
        
        // --- State Variables ---
        let appMode = 'auth'; 
        let loggedInUser = null;
        let isUserLoginLoading = false; 

        // --- Helper Functions ---
        const showMessage = (msg, isError = false) => {
            messageContainer.textContent = msg;
            messageContainer.classList.remove('hidden', 'bg-blue-500', 'bg-red-500');
            messageContainer.classList.add(isError ? 'bg-red-500' : 'bg-blue-500');
            setTimeout(() => {
                 messageContainer.classList.add('hidden');
             }, 3000); 
        };

        const setAppMode = (mode) => {
            appMode = mode;
            authView.classList.add('hidden');
            userView.classList.add('hidden');
            
            document.getElementById('app').classList.remove('max-w-md', 'max-w-xl');

            if (appMode === 'auth') {
                authView.classList.remove('hidden');
                document.getElementById('app').classList.add('max-w-md');
            } else if (appMode === 'userView') {
                userView.classList.remove('hidden');
                userView.classList.add('flex');
                document.getElementById('app').classList.add('max-w-xl');
            }
        };

        // --- Event Handlers ---
        
        const handleLogin = async (e) => {
            e.preventDefault();
            const email = loginEmailInput.value.toLowerCase();
            const phone = loginClientIdxInput.value.toLowerCase();

            // Verificar credenciales de administrador
            if (email === ADMIN_EMAIL && phone === ADMIN_PHONE) {
                window.location.href = './VistaAdmin.html';
                return; // Detener la ejecución del resto de la función
            }

            if (!email || !phone) {
                showMessage("Por favor, introduce tu correo y teléfono para iniciar sesión.", true);
                return;
            }

            console.log("Datos a enviar:", { email: email, phone: phone });

            isUserLoginLoading = true;
            userLoginBtn.textContent = 'Procesando...';
            userLoginBtn.disabled = true;

            try {
                const response = await fetch(appsScriptUrl, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'login', email: email, phone: phone }),
                });
                const result = await response.json();

                if (result.success === false) {
                    showMessage(result.error, true);
                    return;
                }
                
                loggedInUser = result;
                setAppMode('userView');
                
                const rawDate = loggedInUser.Tabla_Fecha_Fin;
                const dateObj = new Date(rawDate);
                const day = String(dateObj.getDate()).padStart(2, '0');
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const year = dateObj.getFullYear();
                const formattedDate = `${day}/${month}/${year}`;

                userDisplayEmail.textContent = loggedInUser.Tabla_Cliente_Correo;
                userDisplayName.textContent = loggedInUser.Tabla_Cliente_Nombre;
                userDisplayPhone.textContent = loggedInUser.Cliente_Telefono;
                userDisplayFin.textContent = formattedDate;

                let subscriptionStatus;
                if (!loggedInUser.Tabla_Renovacion_Status || loggedInUser.Tabla_Renovacion_Status.trim() === '') {
                    subscriptionStatus = 'ACTIVA';
                } else {
                    subscriptionStatus = 'VENCIDA';
                }
                userDisplayStatus.textContent = subscriptionStatus;

                let subscriptionNote = loggedInUser.Suscripcion_Nota;
                const currentDate = new Date();
                const subscriptionEndDate = new Date(loggedInUser.Tabla_Fecha_Fin);
                
                if ((!loggedInUser.Tabla_Renovacion_Status || loggedInUser.Tabla_Renovacion_Status.trim() === '') && subscriptionEndDate < currentDate) {
                    subscriptionNote = 'EN REVISIÓN';
                }
                userDisplayNota.textContent = subscriptionNote;

                loginEmailInput.value = '';
                loginClientIdxInput.value = '';

            } catch (error) {
                console.error("Error al conectar con el servidor:", error);
                showMessage(`Error al conectar con el servidor: ${error.message}`, true);
            } finally {
                isUserLoginLoading = false;
                userLoginBtn.textContent = 'Verificar';
                userLoginBtn.disabled = false;
            }
        };

        const handleLogout = () => {
            loggedInUser = null;
            setAppMode('auth');
            showMessage("Has cerrado sesión.");
        };

        // --- Initial Setup and Event Listeners ---
        window.onload = () => {
            setAppMode('auth'); 
            userLoginForm.addEventListener('submit', handleLogin);
            userLogoutBtn.addEventListener('click', handleLogout);
        };
    </script>
</body>
</html>
